load("@@rules_gzip~//gzip/decompress:defs.bzl", "gzip_decompress")
# load("@rules_rust//bindgen:defs.bzl", "rust_bindgen")

# filegroup(
#     name = "foo",
#     srcs = glob(
#         allow_empty = True,
#         include = ["**"],
#         exclude = [
#             "**/* *",
#             ".tmp_git_root/**/*",
#             "BUILD",
#             "BUILD.bazel",
#             "WORKSPACE",
#             "WORKSPACE.bazel",
#         ],
#     ),
# )

# cc_library(
#     name = "v8_hdrs",
#     srcs = ["src/binding.cc"],
#     # srcs = glob([
#     #     "**/*.cc",
#     #     "**/*.cpp",
#     # ]),
#     hdrs = glob([
#         "**/*.h",
#         "**/*.hpp",
#     ]),
#     copts = [
#         # "-Iexternal/{}/v8/include".format(repo_name()),
#         # "-Iexternal/{}/src".format(repo_name()),
#         "-Iv8/include",
#         "-Isrc",
#     ],
#     # strip_include_prefix = "v8/include",
#     visibility = ["//visibility:public"],
# )

# rust_bindgen(
#     name = "v8_bindings",
#     # cc_lib =
# )

config_setting(
    name = "linux",
    constraint_values = [
        "@platforms//os:linux",
        "@platforms//cpu:x86_64",
    ],
)

config_setting(
    name = "macos_x86",
    constraint_values = [
        "@platforms//os:macos",
        "@platforms//cpu:x86_64",
    ],
)

config_setting(
    name = "macos_arm",
    constraint_values = [
        "@platforms//os:macos",
        "@platforms//cpu:arm64",
    ],
)

gzip_decompress(
    name = "librusty_v8_archive",
    src = select({
        ":macos_x86": "@@_main~third_party~librusty_v8_release_x86_64-apple-darwin//file",
        ":macos_arm": "@@_main~third_party~librusty_v8_release_aarch64-apple-darwin//file",
        "//conditions:default": "@@_main~third_party~librusty_v8_release_x86_64-unknown-linux-gnu//file",
    }),
)

# alias(
#     name = "librusty_v8_archive",
#     actual = select({
#         ":macos": "@@_main~third_party~librusty_v8_release_x86_64-apple-darwin//file",
#         "//conditions:default": "@@_main~third_party~librusty_v8_release_x86_64-unknown-linux-gnu//file",
#     }),
# )

cc_import(
    name = "librusty_v8",
    static_library = ":librusty_v8_archive",
)
